/**
 * @author yangyufei
 * @date 2019-03-05 09:11:48
 * @desc redis的三种服务：redis数据库、发布者和订阅者
 */
const dateFormat    = require('../date_format');

const redisConnector= require('./redis_connector');

const makeMsg = (msgOrObj, level) => {
    let msg = typeof msgOrObj === 'object' ? JSON.stringify(msgOrObj) : msgOrObj + '';

    console.log(`[${dateFormat.getDateTime()}][${level.toUpperCase()}]${msg}`);
};

module.exports = (config, logger) => {
    !config && (config = {host: '127.0.0.1', port: 6379});

    if (!logger) {
        logger = {};
        ['trace', 'debug', 'info', 'warn', 'error', 'fatal'].forEach(level => {
            logger[level] = msgOrObj => makeMsg(msgOrObj, level);
        })
    }

    let redis = redisConnector.getInstance(config, logger, 'redis');
    let publisher = redisConnector.getInstance(config, logger, 'publisher');
    let subscriber = redisConnector.getInstance(config, logger, 'subscriber');

    return {
        redis,
        publisher,
        subscriber,
        close : async () => {
            await redis.disconnect();
            await publisher.disconnect();
            await subscriber.disconnect();
        }
    }
};