/**
 * @author yangyufei
 * @date 2019-03-13 14:43:11
 * @desc
 */
const Ajv   = require('ajv');
const os    = require('os');
const path  = require('path');

const ajv   = new Ajv({useDefaults: true});

const schema = {
    type    : 'object',
    properties: {
        parentId    : {type: 'string'},
        jobId       : {type: 'string', pattern: '^\d{8}@[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}'},
        spiderKey   : {type: 'string', minLength: 1},
        destDir     : {type: 'string', default: path.join(os.homedir(), '.spider', 'failed-tasks')}
    },
    required: ['jobId', 'spiderKey']
};
const validate = ajv.compile(schema);

exports.validate = config => {
    let res = validate(config);

    if (!validate) {
        let err = new Error(`FailedTasksHandler 配置错误：${validate.errors}`);
        err.data = config;
        throw err;
    }
};